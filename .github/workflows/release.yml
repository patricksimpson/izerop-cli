name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  cli:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build CLI binaries
        run: make release VERSION=${{ github.ref_name }}

      - name: Upload CLI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cli-binaries
          path: dist/*

  desktop-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build Linux desktop
        run: |
          mkdir -p dist-desktop
          cd cmd/desktop
          wails build -ldflags "-s -w -X main.version=${{ github.ref_name }}"
          mv build/bin/desktop ../../dist-desktop/izerop-desktop-linux-amd64
        env:
          CGO_ENABLED: 1

      - name: Upload Linux desktop
        uses: actions/upload-artifact@v4
        with:
          name: desktop-linux
          path: dist-desktop/*

  desktop-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build macOS desktop
        run: |
          mkdir -p dist-desktop
          cd cmd/desktop
          wails build -ldflags "-s -w -X main.version=${{ github.ref_name }}"
          cd build/bin
          zip -r ../../../../dist-desktop/izerop-desktop-macos-amd64.zip izerop.app

      - name: Upload macOS desktop
        uses: actions/upload-artifact@v4
        with:
          name: desktop-macos
          path: dist-desktop/*

  desktop-macos-arm:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build macOS ARM desktop
        run: |
          mkdir -p dist-desktop
          cd cmd/desktop
          wails build -ldflags "-s -w -X main.version=${{ github.ref_name }}" -platform darwin/arm64
          cd build/bin
          zip -r ../../../../dist-desktop/izerop-desktop-macos-arm64.zip izerop.app

      - name: Upload macOS ARM desktop
        uses: actions/upload-artifact@v4
        with:
          name: desktop-macos-arm
          path: dist-desktop/*

  desktop-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build Windows desktop
        run: |
          mkdir dist-desktop
          cd cmd/desktop
          wails build -ldflags "-s -w -X main.version=${{ github.ref_name }}"
          Get-ChildItem -Recurse build\bin\
          Copy-Item "build\bin\desktop.exe" "..\..\dist-desktop\izerop-desktop-windows-amd64.exe"

      - name: Upload Windows desktop
        uses: actions/upload-artifact@v4
        with:
          name: desktop-windows
          path: dist-desktop/*

  publish:
    needs: [cli, desktop-linux, desktop-macos, desktop-macos-arm, desktop-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Flatten artifacts
        run: |
          mkdir -p dist
          find release-assets -type f -exec cp {} dist/ \;
          ls -la dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
